<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Payment Page</title>
    <!-- jQuery CDN 추가 -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- 아임포트 스크립트 추가 -->
    <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* 진행 단계 헤더 스타일 */
        .progress-header {
            width: 100%;
            background-color: white;
            padding: 20px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .progress-container {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e8e8e8;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .step-text {
            font-size: 14px;
            color: #666;
        }

        .progress-step.active .step-number {
            background-color: #ff4500;
            color: white;
        }

        .progress-step.active .step-text {
            color: #ff4500;
            font-weight: bold;
        }

        .progress-line {
            position: absolute;
            top: 20px;
            left: 70px;
            right: 70px;
            height: 2px;
            background-color: #e8e8e8;
            z-index: 0;
        }

        .progress-line-active {
            position: absolute;
            top: 20px;
            left: 70px;
            width: 100%;
            /* 3단계이므로 100% */
            height: 2px;
            background-color: #ff4500;
            transition: width 0.3s ease;
            z-index: 0;
        }

        /* 결제 페이지 스타일 */
        .payment-container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 600px;
        }

        .info-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .info-section h3 {
            margin: 10px 0;
            color: #333;
        }

        .payment-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /*이전 단계 버튼 색상*/
        .prev-btn {
            background-color: #b6b2b0;
        }

        button {
            flex: 1;
            padding: 15px 25px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #cardPay {
            background-color: #ff4500;
            color: white;
        }

        #kakaoPay {
            background-color: #FEE500;
            color: #000000;
        }

        button:hover {
            opacity: 0.9;
        }
    </style>
</head>

<body data-step="3">
    <!-- 진행 단계 헤더 -->
    <div class="progress-header">
        <div class="progress-container">
            <div class="progress-line"></div>
            <div class="progress-line-active" id="progressBar"></div>

            <div class="progress-step active">
                <div class="step-number">1</div>
                <div class="step-text">좌석 선택</div>
            </div>

            <div class="progress-step active">
                <div class="step-number">2</div>
                <div class="step-text">주문자 정보</div>
            </div>

            <div class="progress-step active">
                <div class="step-number">3</div>
                <div class="step-text">결제</div>
            </div>
        </div>
    </div>

    <div class="payment-container">
        <div class="info-section">
            <h3>좌석 정보: <span id="seat-info"></span></h3>
            <h3>예매자 : <span id="booking-nickname"></span></h3>
            <h3>이메일 : <span id="booking-email"></span></h3>
            <h3>연락처: <span id="booking-phone"></span></h3>
            <h3>총 결제 금액: <span id="total-price"></span></h3>
        </div>

        <div class="payment-buttons">
            <button type="button" class="prev-btn" id="prev-btn">이전 단계</button> <!-- 이전 단계 버튼 -->
            <button id="cardPay" onclick="handlePayment('html5_inicis.INIpayTest', 'card')">카드 결제</button>
            <button id="kakaoPay" onclick="handlePayment('kakaopay', 'card')">카카오페이 결제</button>
        </div>
    </div>

    <script th:inline="javascript">

        const impCode = 'imp00237821'; // 아임포트 가맹점 코드

        const seatInfo = JSON.parse(localStorage.getItem('selectedSeats')).map(seat => {
            if (typeof seat === 'string') {
                // seat이 문자열인 경우 처리
                return seat; // 전석-7-17 등의 전체 문자열 반환
            } else if (typeof seat === 'object' && seat.seatId) {
                // seat이 객체인 경우 처리
                return seat.seatId; // 객체의 seatId를 그대로 반환
            } else {
                console.error('Unexpected seat format:', seat);
                return '알 수 없음';
            }
        }).join(', '); // 좌석 정보들을 쉼표로 구분하여 문자열로 합침

        // 수정된 좌석 정보를 결제 페이지에 출력
        document.getElementById('seat-info').textContent = seatInfo;

        const bookingInfo = JSON.parse(localStorage.getItem('bookingInfo'));
        const totalPrice = localStorage.getItem('totalPrice');

        const performanceId = localStorage.getItem("performanceId"); // 공연 ID
        const facilityId = localStorage.getItem("facilityId"); // 공연 시설 ID

        if (performanceId && facilityId) {
            console.log("공연 ID:", performanceId);
            console.log("공연 시설 ID:", facilityId);
        }

        document.getElementById('booking-nickname').textContent = bookingInfo.nickname; // 닉네임
        document.getElementById('booking-email').textContent = bookingInfo.email;       // 이메일
        document.getElementById('booking-phone').textContent = bookingInfo.phone;       // 연락처

        document.getElementById('total-price').textContent = totalPrice;

        document.getElementById('prev-btn').addEventListener('click', () => {
            // localStorage에서 필수 정보를 가져옴
            const mt20id = localStorage.getItem('performanceId');
            const selectedDate = localStorage.getItem('selectedDate');
            const selectedTime = localStorage.getItem('selectedTime');
            const dayOfWeek = localStorage.getItem('dayOfWeek');

            if (!mt20id || !selectedDate || !selectedTime || !dayOfWeek) {
                alert("필수 정보가 누락되었습니다. 다시 시도해주세요.");
                return;
            }

            // 이전 단계로 이동 (필수 파라미터 포함)
            window.location.href = `/payment/booking-info?mt20id=${mt20id}&selectedDate=${selectedDate}&selectedTime=${selectedTime}&dayOfWeek=${dayOfWeek}`;
        });



        // 결제 처리 함수
        function handlePayment(pg, payMethod) {
            console.log(`PG: ${pg}, Payment Method: ${payMethod}`);

            // 아임포트 초기화
            IMP.init(impCode);

            // 결제 요청
            IMP.request_pay({
                pg: pg, // PG사
                pay_method: payMethod, // 결제 방식
                merchant_uid: `ORD-${new Date().getTime()}`, // 주문번호
                name: `좌석: ${seatInfo}`, // 상품명
                amount: parseInt(totalPrice), // 결제 금액
                buyer_name: bookingInfo.nickname, // 구매자 이름
                buyer_tel: bookingInfo.phone, // 구매자 연락처
                buyer_email: bookingInfo.email, // 구매자 이메일

            }, function (rsp) {
                if (rsp.success) {
                    // 결제 성공 시 처리
                    console.log("결제 성공:", rsp);

                    alert(`결제가 성공적으로 완료되었습니다.\n고유ID: ${rsp.imp_uid}`);

                    // 결제 데이터 생성
                    const paymentData = {
                        impUid: rsp.imp_uid || null,
                        merchantUid: rsp.merchant_uid || null,
                        payMethod: rsp.pay_method || 'unknown',
                        pgProvider: rsp.pg_provider || null,
                        pgType: rsp.pg_type || null,
                        pgTid: rsp.pg_tid || null,
                        name: rsp.name || `좌석: ${seatInfo}`, // 좌석 정보 반영
                        paidAmount: rsp.paid_amount || 0,
                        currency: rsp.currency || 'KRW',
                        buyerName: rsp.buyer_name || bookingInfo.nickname,
                        buyerTel: rsp.buyer_tel || bookingInfo.phone,
                        buyerAddr: rsp.buyer_addr || 'N/A',
                        buyerPostcode: rsp.buyer_postcode || '00000',
                        buyerEmail: rsp.buyer_email || bookingInfo.email,
                        status: rsp.status,
                        paidAt: rsp.paid_at ? new Date(rsp.paid_at * 1000).toISOString() : null,
                        receiptUrl: rsp.receipt_url || null,
                        seatIds: JSON.parse(localStorage.getItem('selectedSeats')), // 좌석 ID 배열 추가
                        mt20id: performanceId, // 공연 ID 추가
                        mt10id: facilityId, // 공연 시설 ID 추가
                        showDate: localStorage.getItem('selectedDate'), // 공연 날짜 추가
                        showTime: localStorage.getItem('selectedTime') // 공연 시간 추가
                    };
                    console.log("전송할 결제 데이터:", paymentData);




                    // 서버로 결제 검증 요청
                    $.ajax({
                        type: 'POST',
                        url: '/payment/save-payment',
                        contentType: 'application/json',
                        data: JSON.stringify(paymentData), // paymentData를 바로 사용

                        success: function () {
                            alert('결제가 성공적으로 저장되었습니다.');
                            // 필수 파라미터를 URL에 포함
                            const mt20id = localStorage.getItem('performanceId');
                            const selectedDate = localStorage.getItem('selectedDate');
                            const selectedTime = localStorage.getItem('selectedTime');
                            const dayOfWeek = localStorage.getItem('dayOfWeek');


                            window.location.href = `/payment/seat-selection?mt20id=${mt20id}&selectedDate=${selectedDate}&selectedTime=${selectedTime}&dayOfWeek=${dayOfWeek}`;
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            console.error('Error during payment save:', textStatus, errorThrown);

                            // 서버에서 반환된 응답 내용
                            const response = jqXHR.responseText;

                            // 응답 내용을 파싱해서 표시
                            try {
                                const parsedResponse = JSON.parse(response);
                                console.error('서버 응답:', parsedResponse);
                                alert(`결제 저장에 실패했습니다: ${parsedResponse.message || response}`);
                            } catch (e) {
                                console.error('응답 파싱 실패. 원본 응답:', response);
                                alert(`결제 저장에 실패했습니다: ${response}`);
                            }
                        }
                    });
                } else {
                    console.error("결제 실패:", rsp.error_msg);
                    alert(`결제에 실패했습니다. 사유: ${rsp.error_msg}`);
                }
            });
        }
    </script>
</body>

</html>