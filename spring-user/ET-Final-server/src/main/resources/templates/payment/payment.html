<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Payment Page</title>
    <!-- jQuery CDN 추가 -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- 아임포트 스크립트 추가 -->
    <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* 진행 단계 헤더 스타일 */
        .progress-header {
            width: 100%;
            background-color: white;
            padding: 20px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .progress-container {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e8e8e8;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .step-text {
            font-size: 14px;
            color: #666;
        }

        .progress-step.active .step-number {
            background-color: #ff4500;
            color: white;
        }

        .progress-step.active .step-text {
            color: #ff4500;
            font-weight: bold;
        }

        .progress-line {
            position: absolute;
            top: 20px;
            left: 70px;
            right: 70px;
            height: 2px;
            background-color: #e8e8e8;
            z-index: 0;
        }

        .progress-line-active {
            position: absolute;
            top: 20px;
            left: 70px;
            width: 100%;
            /* 3단계이므로 100% */
            height: 2px;
            background-color: #ff4500;
            transition: width 0.3s ease;
            z-index: 0;
        }

        /* 결제 페이지 스타일 */
        .payment-container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 600px;
        }

        .info-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .info-section h3 {
            margin: 10px 0;
            color: #333;
        }

        .payment-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /*이전 단계 버튼 색상*/
        .prev-btn {
            background-color: #b6b2b0;
        }

        button {
            flex: 1;
            padding: 15px 25px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #cardPay {
            background-color: #ff4500;
            color: white;
        }

        #kakaoPay {
            background-color: #FEE500;
            color: #000000;
        }

        button:hover {
            opacity: 0.9;
        }
    </style>
</head>

<body data-step="3">
    <!-- 진행 단계 헤더 -->
    <div class="progress-header">
        <div class="progress-container">
            <div class="progress-line"></div>
            <div class="progress-line-active" id="progressBar"></div>

            <div class="progress-step active">
                <div class="step-number">1</div>
                <div class="step-text">좌석 선택</div>
            </div>

            <div class="progress-step active">
                <div class="step-number">2</div>
                <div class="step-text">주문자 정보</div>
            </div>

            <div class="progress-step active">
                <div class="step-number">3</div>
                <div class="step-text">결제</div>
            </div>
        </div>
    </div>

    <div class="payment-container">
        <div class="info-section">
            <h3>좌석 정보: <span id="seat-info"></span></h3>
            <h3>예매자: <span id="booking-info"></span></h3>
            <h3>총 결제 금액: <span id="total-price"></span></h3>
        </div>

        <div class="payment-buttons">
            <button type="button" class="prev-btn" id="prev-btn">이전 단계</button> <!-- 이전 단계 버튼 -->
            <button id="cardPay" onclick="handlePayment('html5_inicis.INIpayTest', 'card')">카드 결제</button>
            <button id="kakaoPay" onclick="handlePayment('kakaopay', 'card')">카카오페이 결제</button>
        </div>
    </div>

    <script th:inline="javascript">

        const impCode = 'imp00237821'; // 아임포트 가맹점 코드

        const seatInfo = JSON.parse(localStorage.getItem('selectedSeats')).map(seatId => {
            const parts = seatId.split('-');
            const gradeName = parts[1]; // R석, VIP석 등급
            const seatNumber = parts[2]; // A1, A2 등 좌석 번호
            // "전석"일 경우 "석"을 붙이지 않음
            if (gradeName === "전석") {
                return `${gradeName} ${seatNumber}`; // 전석 A1 형식으로 변환
            }
            return `${gradeName}석 ${seatNumber}`; // R석 A1 형식으로 변환
        }).join(', ');

        const bookingInfo = JSON.parse(localStorage.getItem('bookingInfo'));
        const totalPrice = localStorage.getItem('totalPrice');
        document.getElementById('seat-info').textContent = seatInfo;
        document.getElementById('booking-info').textContent = `${bookingInfo.name} (${bookingInfo.phone})`;
        document.getElementById('total-price').textContent = totalPrice;

        // '이전 단계' 버튼 클릭 시 처리
        document.getElementById('prev-btn').addEventListener('click', () => {
            // 주문자 정보 확인 페이지로 이동
            window.location.href = '/payment/booking-info';
        });

        // 결제 처리 함수
        function handlePayment(pg, payMethod) {
            console.log(`PG: ${pg}, Payment Method: ${payMethod}`);

            // 아임포트 초기화
            IMP.init(impCode);

            // 결제 요청
            IMP.request_pay({
                pg: pg, // PG사
                pay_method: payMethod, // 결제 방식
                merchant_uid: `ORD-${new Date().getTime()}`, // 주문번호
                name: `좌석: ${seatInfo}`, // 상품명
                amount: parseInt(totalPrice), // 결제 금액
                buyer_name: bookingInfo.name, // 구매자 이름
                buyer_tel: bookingInfo.phone // 구매자 연락처

            }, function (rsp) {
                if (rsp.success) {
                    // 결제 성공 시 처리
                    console.log("결제 성공:", rsp);

                    alert(`결제가 성공적으로 완료되었습니다.\n고유ID: ${rsp.imp_uid}`);

                    // 결제 데이터 생성
                    const paymentData = {
                        impUid: rsp.imp_uid || null,
                        merchantUid: rsp.merchant_uid || null,
                        payMethod: rsp.pay_method || 'unknown',
                        pgProvider: rsp.pg_provider || null,
                        pgType: rsp.pg_type || null,
                        pgTid: rsp.pg_tid || null,
                        name: rsp.name || `좌석: ${seatInfo}`,
                        paidAmount: rsp.paid_amount || 0,
                        currency: rsp.currency || 'KRW',
                        buyerName: rsp.buyer_name || bookingInfo.name || 'Unknown',
                        buyerTel: rsp.buyer_tel || bookingInfo.phone || '000-0000-0000',
                        buyerAddr: rsp.buyer_addr || 'N/A',
                        buyerPostcode: rsp.buyer_postcode || '00000',
                        buyerEmail: rsp.buyer_email || 'unknown',
                        status: rsp.status || 'unknown',
                        paidAt: rsp.paid_at ? new Date(rsp.paid_at * 1000).toISOString() : null,
                        receiptUrl: rsp.receipt_url || null,
                        seatIds: JSON.parse(localStorage.getItem('selectedSeats')), // 좌석 ID 배열 추가
                    };
                    console.log("전송할 결제 데이터:", paymentData);




                    // 서버로 결제 검증 요청
                    $.ajax({
                        type: 'POST',
                        url: '/payment/save-payment',
                        contentType: 'application/json',
                        data: JSON.stringify(paymentData), // paymentData를 바로 사용

                        success: function () {
                            alert('결제가 성공적으로 저장되었습니다.');
                            //window.location.href = `/payment/order-summary?orderId=${rsp.merchant_uid}`;
                            window.location.href = `/payment/seat-selection`;
                        },
                        error: function () {
                            console.error('Error during payment save:', textStatus, errorThrown);
                            alert(`결제 저장에 실패했습니다: ${jqXHR.responseText || textStatus}`);
                        }
                    });
                } else {
                    console.error("결제 실패:", rsp.error_msg);
                    alert(`결제에 실패했습니다. 사유: ${rsp.error_msg}`);
                }
            });
        }
    </script>
</body>

</html>