<!DOCTYPE html>
<html lang="ko">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>티켓팅 시스템</title>
	<link rel="stylesheet" href="/css/main-style.css">

	<th:block th:replace="~{common/common}"></th:block>
</head>

<body>

	<th:block th:replace="~{common/header}"></th:block>

	<!-- hero 섹션 바로 다음에 추가 -->
	<div class="ticker-wrap">
		<div class="ticker">
			<!-- 타임리프로 performanceRanking을 반복 -->
			<div th:each="ranking, iterStat : ${performanceRanking}">
				<div class="ticker-item">
					<!-- 클릭 시 해당 MT20ID로 상세 페이지로 이동 -->
					<a th:href="@{/performance/detail/{mt20id}(mt20id=${ranking.mt20id})}" class="ticker-link">
						🎟️ <span th:text="${iterStat.index + 1}">1</span>위:
						<span th:text="${ranking.prfnm}">공연 제목</span>
						(평점: <span th:text="${ranking.avgRating}">평점</span>⭐)
					</a>
				</div>
			</div>
		</div>
	</div>

	<div class="section visible" id="hero">
		<div class="hero">
			<h1>당신의 꿈의 공연을 찾아보세요!</h1>
		</div>
	</div>

	<!-- 케러셀 HTML 부분 -->
	<div class="section carousel-section" id="performances-carousel">
		<div class="section-header">
			<h2 class="main-title">주요 공연 소개</h2>
			<h3 class="current-performance" th:text="${mainPerform[0].prfnm}">공연 제목</h3>
		</div>
		<div class="custom-carousel">
			<div class="carousel-container">
				<th:block th:each="mainPerform, status : ${mainPerform}">
					<div class="carousel-slide" th:classappend="${status.first ? 'active' : ''}"
						th:data-title="${mainPerform.prfnm}"
						th:data-link="@{/performance/detail/{mt20id}(mt20id=${mainPerform.mt20id})}">
						<div class="carousel-image">
							<img th:src="${mainPerform.poster}" alt="공연 이미지" loading="lazy">
						</div>
					</div>
				</th:block>
				<button class="carousel-arrow prev-arrow">&#10094;</button>
				<button class="carousel-arrow next-arrow">&#10095;</button>
			</div>
			<div class="carousel-bottom">
				<a th:href="@{/performance/detail/{mt20id}(mt20id=${mainPerform[0].mt20id})}" class="carousel-btn"
					style="cursor: pointer;">자세히 보기</a>
				<div class="carousel-indicators">
					<!-- 인디케이터는 JavaScript에서 동적으로 생성됩니다 -->
				</div>
			</div>
		</div>
	</div>

	<!-- carousel-section 다음에 추가 -->
	<div class="section statistics-section" id="performance-stats">
		<div class="section-header">
			<h2 class="main-title">공연 통계</h2>
		</div>

		<!-- 공연 통계 테이블 -->
		<div class="table-container">
			<!-- 통계 차트 -->
			<div class="chart-container">
				<canvas id="concertChart"></canvas>
			</div>

			<div class="table-scroll">
				<table>
					<thead>
						<tr>
							<th>카테고리</th>
							<th>공연 수</th>
							<th>공연일 수</th>
							<th>예매 수</th>
							<th>취소 예매 수</th>
							<th>총 예매 수</th>
							<th>총 예매 금액</th>
						</tr>
					</thead>
					<tbody>
						<!-- 연극 데이터 -->
						<tr>
							<td>연극</td>
							<td>422</td>
							<td>6305</td>
							<td>192932</td>
							<td>69216</td>
							<td>123716</td>
							<td>3,278,347,195</td>
						</tr>
						<!-- 서양음악(클래식) 데이터 -->
						<tr>
							<td>서양음악(클래식)</td>
							<td>1054</td>
							<td>1325</td>
							<td>201572</td>
							<td>60655</td>
							<td>140917</td>
							<td>3,516,942,954</td>
						</tr>
						<!-- 뮤지컬 데이터 -->
						<tr>
							<td>뮤지컬</td>
							<td>668</td>
							<td>7228</td>
							<td>766050</td>
							<td>357941</td>
							<td>408109</td>
							<td>28,605,122,773</td>
						</tr>
						<!-- 합계 데이터 -->
						<tr>
							<td>합계</td>
							<td>2144</td>
							<td>14858</td>
							<td>1160554</td>
							<td>487812</td>
							<td>672742</td>
							<td>35,399,462,922</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
	</div>
	
	<!-- 공지사항 영역 -->
	<div>
		
	</div>

	<!-- common/footer 추가-->
	<th:block th:replace="~{common/footer}"></th:block>


	<!-- Chart.js 라이브러리 추가 -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>

	<script>
		// 캐러셀 클래스 추가
		class Carousel {
			constructor() {
				this.carousel = document.querySelector('.custom-carousel');
				this.slides = Array.from(this.carousel.querySelectorAll('.carousel-slide'));
				this.totalSlides = this.slides.length;
				this.currentSlide = 0;
				this.autoPlayInterval = null;
				this.performanceTitle = document.querySelector('.current-performance');
				this.titles = this.slides.map(slide => slide.dataset.title);
				this.detailLinks = Array.from(this.carousel.querySelectorAll('[data-link]'))
					.map(el => el.dataset.link);
				this.detailButton = this.carousel.querySelector('.carousel-btn');

				this.initializeCarousel();
				this.addEventListeners();
				this.startAutoPlay();
			}

			initializeCarousel() {
				// 인디케이터 생성
				const indicatorsContainer = this.carousel.querySelector('.carousel-indicators');
				indicatorsContainer.innerHTML = ''; // 기존 인디케이터 초기화

				for (let i = 0; i < this.totalSlides; i++) {
					const indicator = document.createElement('div');
					indicator.className = `indicator ${i === 0 ? 'active' : ''}`;
					indicator.addEventListener('click', () => this.goToSlide(i));
					indicatorsContainer.appendChild(indicator);
				}

				// 인디케이터 요소들을 저장
				this.indicators = Array.from(indicatorsContainer.querySelectorAll('.indicator'));
			}

			addEventListeners() {
				this.carousel.addEventListener('mouseenter', () => this.stopAutoPlay());
				this.carousel.addEventListener('mouseleave', () => this.startAutoPlay());

				this.carousel.querySelector('.prev-arrow').addEventListener('click', () => {
					this.prevSlide();
					this.resetAutoPlay();
				});

				this.carousel.querySelector('.next-arrow').addEventListener('click', () => {
					this.nextSlide();
					this.resetAutoPlay();
				});
			}

			updateSlides() {
				const activeSlide = this.slides[this.currentSlide];
				document.querySelector('.carousel-slide.active').classList.remove('active');
				activeSlide.classList.add('active');

				this.performanceTitle.textContent = activeSlide.dataset.title;

				// href 속성 직접 변경
				this.detailButton.href = activeSlide.dataset.link;

				this.indicators.forEach((indicator, index) => {
					if (index === this.currentSlide) {
						indicator.classList.add('active');
					} else {
						indicator.classList.remove('active');
					}
				});
			}

			nextSlide() {
				this.currentSlide = (this.currentSlide + 1) % this.totalSlides;
				this.updateSlides();
			}

			prevSlide() {
				this.currentSlide = (this.currentSlide - 1 + this.totalSlides) % this.totalSlides;
				this.updateSlides();
			}

			goToSlide(index) {
				this.currentSlide = index;
				this.updateSlides();
				this.resetAutoPlay();
			}

			startAutoPlay() {
				this.autoPlayInterval = setInterval(() => this.nextSlide(), 5000);
			}

			stopAutoPlay() {
				if (this.autoPlayInterval) {
					clearInterval(this.autoPlayInterval);
					this.autoPlayInterval = null;
				}
			}

			resetAutoPlay() {
				this.stopAutoPlay();
				this.startAutoPlay();
			}
		}

		document.addEventListener('DOMContentLoaded', function () {
			// 캐러셀 초기화
			new Carousel();

			// 차트 초기화
			const ctx = document.getElementById('concertChart').getContext('2d');
			new Chart(ctx, {
				type: 'bar',  // 바 차트
				data: {
					labels: ['연극', '서양음악(클래식)', '뮤지컬', '합계'],  // 카테고리
					datasets: [{
						label: '예매 수',
						data: [192932, 201572, 766050, 672742],  // 예매 수
						backgroundColor: 'rgba(75, 192, 192, 0.2)',
						borderColor: 'rgba(75, 192, 192, 1)',
						borderWidth: 1
					}, {
						label: '취소 예매 수',
						data: [69216, 60655, 357941, 487812],  // 취소 예매 수
						backgroundColor: 'rgba(255, 99, 132, 0.2)',
						borderColor: 'rgba(255, 99, 132, 1)',
						borderWidth: 1
					}]
				},
				options: {
					scales: {
						y: {
							beginAtZero: true
						}
					},
					responsive: true,
					plugins: {
						legend: {
							position: 'top',
						}
					}
				}
			});

		});

		const sections = document.querySelectorAll('.section');

		const options = {
			root: null,
			rootMargin: '0px',
			threshold: 0.1
		};

		const observer = new IntersectionObserver((entries) => {
			entries.forEach(entry => {
				if (entry.isIntersecting) {
					entry.target.classList.add('visible');
				} else {
					entry.target.classList.remove('visible');
				}
			});
		}, options);

		sections.forEach(section => {
			observer.observe(section);
		});

		function scrollToSection(sectionId) {
			const section = document.getElementById(sectionId);
			section.scrollIntoView({behavior: 'smooth'});
		}

	</script>

	<script src="/js/main.js"></script>

</body>

</html>