<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>공연 등록 페이지</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-bs4.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <th:block th:replace="~{common/common}"></th:block>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f9f9f9;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        .schedule-group, .price-group {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            position: relative;
            background-color: #fff;
        }

        .remove-schedule {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #dc3545;
            cursor: pointer;
            font-size: 1.2em;
        }

        .time-slots {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .section-title {
            margin: 30px 0 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .add-btn {
            margin: 10px 0 20px;
            width: 100%;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .time-input {
            width: 120px;
            text-align: center;
        }

        select[multiple] {
            height: 120px;
        }
    </style>
</head>
<body>
    <th:block th:replace="~{common/header}"></th:block>
    <div class="container">
        <h1>공연 등록</h1>
        <form id="performance-form">
            <!-- 공연 기본 정보 -->
            <div class="section-title">
                <h4>기본 정보</h4>
            </div>

            <!-- 공연 장소 -->
            <div class="section-title">
                <h4>공연 장소</h4>
            </div>

            <div id="schedule-container">
                <div class="schedule-group">
                    <span class="remove-schedule">✕</span>
                    <div class="form-group">
                        <label>장소 선택</label>
                        <select class="form-control adres-select" multiple>
                            <option value=""></option>
                            <option value=""></option>
                            <option value=""></option>
                            <option value=""></option>
                            <option value=""></option>
                            <option value=""></option>
                        </select>
                    </div>
                </div>
            </div>
            <button type="button" class="btn btn-success add-btn" id="add-schedule">+ 장소 선택</button>

            <!-- 공연명 입력 -->
            <div class="form-group">
                <label for="prfnm">공연명</label>
                <input type="text" id="prfnm" name="prfnm" class="form-control" required>
            </div>

            <!-- 런타임 입력 -->
            <div class="form-group">
                <label for="runtime">런타임(분)</label>
                <input type="number" id="runtime" name="runtime" class="form-control" placeholder="런타임을 입력하세요" required>
            </div>

            <!-- 출연진 입력 -->
            <div class="form-group">
                <label for="cast">출연진</label>
                <textarea id="cast" name="cast" class="form-control" placeholder="출연진을 입력하세요" rows="3" required></textarea>
            </div>

            <!-- 장르 입력 -->
            <div class="form-group">
                <label for="genere">장르</label>
                <textarea id="cast" name="genere" class="form-control" placeholder="장르를 입력하세요" rows="3" required></textarea>
            </div>

            <!-- 공연 기간 -->
            <div class="section-title">
                <h4>공연 기간</h4>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="prfpdfrom">시작일</label>
                        <input type="text" id="prfpdfrom" name="prfpdfrom" class="form-control" required>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="prfpdto">종료일</label>
                        <input type="text" id="prfpdto" name="prfpdto" class="form-control" required>
                    </div>
                </div>
            </div>

            <!-- 공연 시간 -->
            <div class="section-title">
                <h4>공연 시간</h4>
            </div>

            <div id="schedule-container">
                <div class="schedule-group">
                    <span class="remove-schedule">✕</span>
                    <div class="form-group">
                        <label>요일 선택 (여러 개 선택 가능)</label>
                        <select class="form-control days-select" multiple>
                            <option value="월요일">월요일</option>
                            <option value="화요일">화요일</option>
                            <option value="수요일">수요일</option>
                            <option value="목요일">목요일</option>
                            <option value="금요일">금요일</option>
                            <option value="토요일">토요일</option>
                            <option value="일요일">일요일</option>
                            <option value="HOL">공휴일</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>공연 시간 (콤마로 구분)</label>
                        <input type="text" class="form-control times-input" placeholder="예: 14:00,19:30">
                    </div>
                </div>
            </div>
            <button type="button" class="btn btn-success add-btn" id="add-schedule">+ 공연 시간 추가</button>

            <!-- 가격 정보 -->
            <div class="section-title">
                <h4>티켓 가격</h4>
            </div>

            <div id="price-container">
                <div class="price-group">
                    <span class="remove-schedule">✕</span>
                    <div class="form-group">
                        <label>좌석 등급</label>
                        <select class="form-control grade-select">
                            <option value="VIP">VIP석</option>
                            <option value="R">R석</option>
                            <option value="S">S석</option>
                            <option value="A">A석</option>
                            <option value="B">B석</option>
                            <option value="전석">전석</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>가격</label>
                        <input type="number" class="form-control price-input" min="0" step="1000" placeholder="가격을 입력하세요">
                    </div>
                </div>
            </div>
            <button type="button" class="btn btn-success add-btn" id="add-price">+ 가격 정보 추가</button>

            <!-- 공연 설명 -->
            <div class="form-group">
                <label for="description">공연 설명</label>
                <textarea id="description" name="description" class="form-control"></textarea>
            </div>

            <button type="submit" class="btn btn-primary btn-lg btn-block mt-5">공연 등록</button>
        </form>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-bs4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/lang/summernote-ko-KR.js"></script>

    <script>
        $(document).ready(function() {
            // Flatpickr 초기화
            flatpickr("#prfpdfrom", {
                locale: "ko",
                dateFormat: "Y-m-d",
                minDate: "today"
            });

            flatpickr("#prfpdto", {
                locale: "ko",
                dateFormat: "Y-m-d",
                minDate: "today"
            });

            // 공연 시간 추가
            $("#add-schedule").click(function() {
                const scheduleHtml = `
                    <div class="schedule-group">
                        <span class="remove-schedule">✕</span>
                        <div class="form-group">
                            <label>요일 선택 (여러 개 선택 가능)</label>
                            <select class="form-control days-select" multiple>
                                <option value="월요일">월요일</option>
                                <option value="화요일">화요일</option>
                                <option value="수요일">수요일</option>
                                <option value="목요일">목요일</option>
                                <option value="금요일">금요일</option>
                                <option value="토요일">토요일</option>
                                <option value="일요일">일요일</option>
                                <option value="HOL">공휴일</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>공연 시간 (콤마로 구분)</label>
                            <input type="text" class="form-control times-input" placeholder="예: 14:00,19:30">
                        </div>
                    </div>
                `;
                $("#schedule-container").append(scheduleHtml);
            });

            // 가격 정보 추가
            $("#add-price").click(function() {
                const priceHtml = `
                    <div class="price-group">
                        <span class="remove-schedule">✕</span>
                        <div class="form-group">
                            <label>좌석 등급</label>
                            <select class="form-control grade-select">
                                <option value="VIP">VIP석</option>
                                <option value="R">R석</option>
                                <option value="S">S석</option>
                                <option value="A">A석</option>
                                <option value="B">B석</option>
                                <option value="전석">전석</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>가격</label>
                            <input type="number" class="form-control price-input" min="0" step="1000" placeholder="가격을 입력하세요">
                        </div>
                    </div>
                `;
                $("#price-container").append(priceHtml);
            });

            // Initialize Summernote editor
            $('#description').summernote({
                height: 300,
                lang: 'ko-KR',
                placeholder: '공연 설명을 입력하세요. 이미지나 포스터를 첨부할 수 있습니다.',
                toolbar: [
                    ['style', ['style']],
                    ['font', ['bold', 'italic', 'underline', 'clear']],
                    ['color', ['color']],
                    ['para', ['ul', 'ol', 'paragraph']],
                    ['insert', ['link', 'picture']]
                ]
            });

            // 삭제 버튼
            $(document).on("click", ".remove-schedule", function() {
                $(this).closest(".schedule-group, .price-group").remove();
            });

            // 폼 제출
            $("#performance-form").submit(function(e) {
                e.preventDefault();

                // 공연 시간 정보 수집
                const dtguidance = [];
                $('.schedule-group').each(function() {
                    const days = $(this).find('.days-select').val();
                    const times = $(this).find('.times-input').val();
                    
                    if (days && days.length > 0 && times) {
                        // 선택된 각 요일에 대해 시간 정보 생성
                        days.forEach(day => {
                            dtguidance.push(`${day}(${times})`);
                        });
                    }
                });

                // 가격 정보 수집
                const pcseguidance = [];
                $('.price-group').each(function() {
                    const grade = $(this).find('.grade-select').val();
                    const price = $(this).find('.price-input').val();
                    
                    if (grade && price) {
                        pcseguidance.push(`${grade}석 ${Number(price).toLocaleString()}원`);
                    }
                });

                // 전체 데이터 구성
                const formData = {
                    mt20id: $('#mt20id').val(),
                    prfnm: $('#prfnm').val(),
                    genrenm: $('#genrenm').val(),
                    prfpdfrom: $('#prfpdfrom').val(),
                    prfpdto: $('#prfpdto').val(),
                    dtguidance: dtguidance.join(', '),
                    pcseguidance: pcseguidance.join(', ')
                };

                // 데이터 검증
                if (dtguidance.length === 0) {
                    alert('최소 하나의 공연 시간을 입력해주세요.');
                    return;
                }

                if (pcseguidance.length === 0) {
                    alert('최소 하나의 가격 정보를 입력해주세요.');
                    return;
                }

                // API 호출
                $.ajax({
                    url: '/api/performance',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function(response) {
                        alert('공연이 성공적으로 등록되었습니다.');
                        location.reload();
                    },
                    error: function(xhr, status, error) {
                        alert('공연 등록 중 오류가 발생했습니다.');
                    }
                });
            });
        });
    </script>
    <th:block th:replace="~{common/footer}"></th:block>
</body>
</html>
